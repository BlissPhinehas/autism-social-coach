<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forest Friend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap");

      * {
        font-family: "Fredoka", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .activity-card {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .activity-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .message-bubble {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .forest-bg {
        background: linear-gradient(to bottom, #a8e6cf 0%, #6fb583 100%);
      }

      .chat-container {
        background: linear-gradient(to bottom, #f0f9ff 0%, #e0f2fe 100%);
      }
    </style>
  </head>

  <body class="min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="glass-card rounded-3xl shadow-2xl p-6 mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="text-5xl">ü¶ä</div>
            <div>
              <h1 class="text-3xl font-bold text-gray-800">Forest Friend</h1>
              <p class="text-gray-600">Let's do fun things together!</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div
              id="childNameDisplay"
              class="text-2xl font-bold text-purple-600 hidden"
            >
              <!-- Child name will appear here -->
            </div>
            <button
              id="startSessionBtn"
              onclick="startGuidedSession()"
              aria-pressed="false"
              class="ml-3 bg-linear-to-r from-green-400 to-green-600 text-white px-4 py-2 rounded-full font-bold shadow-sm"
            >
              üåü Start Session
            </button>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Activities Sidebar -->
        <div class="lg:col-span-1">
          <div class="glass-card rounded-3xl shadow-2xl p-6">
            <h2
              class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"
            >
              <span>üéØ</span> Choose an Activity
            </h2>

            <div class="space-y-4">
              <!-- Morning Routine -->
              <div
                onclick="startActivity('morning-routine')"
                class="activity-card bg-linear-to-br from-yellow-100 to-orange-100 rounded-2xl p-4 shadow-lg border-2 border-yellow-300"
              >
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-4xl">‚òÄÔ∏è</span>
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">
                      Morning Routine
                    </h3>
                    <p class="text-sm text-gray-600">
                      Brush teeth, get dressed!
                    </p>
                  </div>
                </div>
              </div>

              <!-- Math Fun -->
              <div
                onclick="startActivity('math-fun')"
                class="activity-card bg-linear-to-br from-blue-100 to-indigo-100 rounded-2xl p-4 shadow-lg border-2 border-blue-300"
              >
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-4xl">üî¢</span>
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">Math Time</h3>
                    <p class="text-sm text-gray-600">Fun with numbers!</p>
                  </div>
                </div>
              </div>

              <!-- Praise Time -->
              <div
                onclick="startActivity('praise-time')"
                class="activity-card bg-linear-to-br from-pink-100 to-rose-100 rounded-2xl p-4 shadow-lg border-2 border-pink-300"
              >
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-4xl">‚≠ê</span>
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">Praise Time</h3>
                    <p class="text-sm text-gray-600">
                      Share what you did well!
                    </p>
                  </div>
                </div>
              </div>

              <!-- Feelings Check -->
              <div
                onclick="startActivity('feelings-check')"
                class="activity-card bg-linear-to-br from-purple-100 to-violet-100 rounded-2xl p-4 shadow-lg border-2 border-purple-300"
              >
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-4xl">üí≠</span>
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">How I Feel</h3>
                    <p class="text-sm text-gray-600">Talk about feelings</p>
                  </div>
                </div>
              </div>

              <!-- Story Time -->
              <div
                onclick="startActivity('story-time')"
                class="activity-card bg-linear-to-br from-green-100 to-emerald-100 rounded-2xl p-4 shadow-lg border-2 border-green-300"
              >
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-4xl">üìñ</span>
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">Story Time</h3>
                    <p class="text-sm text-gray-600">
                      Listen to forest stories!
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activity Tracker -->
            <div class="mt-8 pt-6 border-t-2 border-gray-200">
              <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <span>‚úÖ</span> Completed Today
              </h3>
              <div id="completedList" class="text-sm text-gray-600">
                No activities yet - pick one above!
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class="lg:col-span-2">
          <div
            class="glass-card rounded-3xl shadow-2xl overflow-hidden"
            style="height: calc(100vh - 200px)"
          >
            <!-- Current Activity Header -->
            <div
              id="activityHeader"
              class="hidden bg-linear-to-r from-purple-500 to-indigo-500 text-white p-4 text-center"
            >
              <div class="flex items-center justify-center gap-2">
                <span id="activityEmoji" class="text-3xl"></span>
                <span id="activityName" class="text-xl font-bold"></span>
              </div>
            </div>

            <!-- Messages -->
            <div
              id="messages"
              class="chat-container flex-1 overflow-y-auto p-6 space-y-4"
              style="height: calc(100% - 140px)"
            >
              <!-- Messages appear here -->
            </div>

            <!-- Input Area -->
            <div class="bg-white border-t-2 border-gray-200 p-4">
              <!-- Session-specific quick controls will appear here for guided activities -->
              <div id="sessionControls" class="mb-3" aria-live="polite"></div>
              <div class="flex gap-3">
                <input
                  type="text"
                  id="messageInput"
                  placeholder="Type here..."
                  class="flex-1 px-6 py-4 border-2 border-gray-300 rounded-full focus:border-purple-500 focus:outline-none text-lg"
                  onkeypress="handleKeyPress(event)"
                />
                <button
                  onclick="sendMessage()"
                  class="bg-linear-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white px-8 py-4 rounded-full font-bold text-lg shadow-lg"
                >
                  Send
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let sessionId = "session-" + Date.now();
      let setupComplete = false;
      let currentActivity = null;
      let completedActivities = [];
      const API_BASE = window.location.origin;

      const activityInfo = {
        "morning-routine": { emoji: "‚òÄÔ∏è", name: "Morning Routine" },
        "math-fun": { emoji: "üî¢", name: "Math Time" },
        "praise-time": { emoji: "‚≠ê", name: "Praise Time" },
        "feelings-check": { emoji: "üí≠", name: "How I Feel" },
        "story-time": { emoji: "üìñ", name: "Story Time" }
      };

      // Guided session configuration for a kid-friendly flow
      let sessionActive = false;
      let currentStep = -1;
      const sessionSteps = [
        {
          id: "brush",
          prompt:
            "Please brush your teeth for two minutes. Say 'Done' when you're finished.",
          type: "action"
        },
        {
          id: "praise",
          prompt: "Tell me one thing you did well today. I'll cheer for you!",
          type: "action"
        },
        {
          id: "math",
          prompt:
            "Math time! If you have 3 apples and I give you 2 more, how many apples do you have?",
          type: "choice",
          choices: ["4", "5"]
        },
        {
          id: "chat",
          prompt: "What's your favorite toy? Tell me its name.",
          type: "action"
        }
      ];

      window.onload = function () {
        addMessage("assistant", "Hi! What's your name?");
      };

      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        addMessage("user", message);
        input.value = "";

        const loadingId = addLoadingMessage();

        try {
          const response = await fetch(`${API_BASE}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              sessionId,
              parentMode: !setupComplete
            })
          });

          const data = await response.json();
          removeLoadingMessage(loadingId);
          addMessage("assistant", data.response);

          if (data.setupComplete !== undefined) {
            setupComplete = data.setupComplete;
            if (data.childName) {
              document.getElementById("childNameDisplay").textContent =
                `Hi ${data.childName}! üëã`;
              document
                .getElementById("childNameDisplay")
                .classList.remove("hidden");
            }
          }

          if (data.currentActivity) {
            currentActivity = data.currentActivity;
            showActivityHeader(currentActivity);
          }

          if (data.activitiesCompleted) {
            completedActivities = data.activitiesCompleted;
            updateCompletedList();
          }
        } catch (error) {
          console.error("Error:", error);
          removeLoadingMessage(loadingId);
          addMessage("assistant", "Oops! Let me try again!");
        }
      }

      function addMessage(role, content) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-bubble flex ${role === "user" ? "justify-end" : "justify-start"}`;

        // Prevent obvious repetition for assistant replies by detecting an
        // identical previous assistant message and nudging the reply to feel
        // more interactive (append a friendly suffix or alternate phrasing).
        if (role === "assistant") {
          // find the last assistant bubble (justify-start)
          const bubbles = Array.from(messagesDiv.querySelectorAll('.message-bubble'));
          let lastAssistantText = null;
          for (let i = bubbles.length - 1; i >= 0; i--) {
            const el = bubbles[i];
            if (el.className.includes('justify-start')) {
              lastAssistantText = el.textContent && el.textContent.trim();
              break;
            }
          }

          if (lastAssistantText && lastAssistantText === content) {
            const variants = [
              " Great job! üåü",
              " Can you tell me more about that?",
              " That was lovely ‚Äî what happened next?",
              " You're doing amazing!"
            ];
            const suffix = variants[Math.floor(Math.random() * variants.length)];
            content = content + suffix;
          }
        }

        const bgColor =
          role === "user"
            ? "bg-gradient-to-r from-purple-500 to-indigo-500 text-white"
            : "bg-white text-gray-800 shadow-md border-2 border-gray-200";

        messageDiv.innerHTML = `
                <div class="max-w-md ${bgColor} px-6 py-4 rounded-3xl">
                    <p class="text-lg leading-relaxed">${content}</p>
                </div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addLoadingMessage() {
        const messagesDiv = document.getElementById("messages");
        const loadingDiv = document.createElement("div");
        loadingDiv.id = "loading-" + Date.now();
        loadingDiv.className = "flex justify-start message-bubble";
        loadingDiv.innerHTML = `
                <div class="bg-white px-6 py-4 rounded-3xl shadow-md border-2 border-gray-200">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return loadingDiv.id;
      }

      function removeLoadingMessage(id) {
        const loading = document.getElementById(id);
        if (loading) loading.remove();
      }

      async function startActivity(type) {
        try {
          const response = await fetch(`${API_BASE}/api/exercise`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ exerciseType: type, sessionId })
          });

          const data = await response.json();
          addMessage("assistant", data.response || data);

          currentActivity = type;
          showActivityHeader(type);
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function showActivityHeader(type) {
        const header = document.getElementById("activityHeader");
        const emoji = document.getElementById("activityEmoji");
        const name = document.getElementById("activityName");

        const info = activityInfo[type];
        if (info) {
          emoji.textContent = info.emoji;
          name.textContent = info.name;
          header.classList.remove("hidden");
        }
      }

      function updateCompletedList() {
        const list = document.getElementById("completedList");
        if (completedActivities.length === 0) {
          list.innerHTML =
            '<p class="text-gray-600">No activities yet - pick one above!</p>';
        } else {
          list.innerHTML = completedActivities
            .map((activity) => {
              const info = activityInfo[activity];
              return `<div class="flex items-center gap-2 mb-2">
                        <span>${info?.emoji || "‚úÖ"}</span>
                        <span>${info?.name || activity}</span>
                    </div>`;
            })
            .join("");
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // --- Guided session functions ---
      function startGuidedSession() {
        if (sessionActive) return;
        sessionActive = true;
        currentStep = -1;
        const btn = document.getElementById("startSessionBtn");
        if (btn) btn.setAttribute("aria-pressed", "true");
        nextSessionStep();
      }

      function nextSessionStep() {
        currentStep++;
        if (currentStep >= sessionSteps.length) {
          addMessage(
            "assistant",
            "Amazing! You completed the session ‚Äî great job! üéâ"
          );
          sessionActive = false;
          const btn = document.getElementById("startSessionBtn");
          if (btn) btn.setAttribute("aria-pressed", "false");
          const sc = document.getElementById("sessionControls");
          if (sc) sc.innerHTML = "";
          return;
        }

        const step = sessionSteps[currentStep];
        addMessage("assistant", step.prompt);
        showSessionControls(step);
      }

      function showSessionControls(step) {
        const sc = document.getElementById("sessionControls");
        if (!sc) return;
        sc.innerHTML = "";

        if (step.type === "choice" && Array.isArray(step.choices)) {
          step.choices.forEach((choice) => {
            const b = document.createElement("button");
            b.className =
              "px-4 py-2 rounded-full bg-indigo-500 text-white font-bold mr-2";
            b.textContent = choice;
            b.onclick = () => handleQuickAnswer(choice);
            sc.appendChild(b);
          });
        } else {
          const done = document.createElement("button");
          done.className =
            "px-4 py-2 rounded-full bg-green-500 text-white font-bold";
          done.textContent = "Done";
          done.onclick = () => handleQuickAnswer("done");
          sc.appendChild(done);
        }
      }

      function handleQuickAnswer(answer) {
        addMessage("user", answer);
        if (answer === "done") {
          addMessage("assistant", "Yay! Great job! That was awesome. üåü");
        } else if (!isNaN(Number(answer))) {
          addMessage(
            "assistant",
            "Nice answer! You are great with numbers! üéâ"
          );
        } else {
          addMessage("assistant", "Thanks for sharing! That was lovely. üíñ");
        }

        // Small delay before moving to the next step to let the child read praise
        setTimeout(nextSessionStep, 900);
      }
    </script>
  </body>
</html>
