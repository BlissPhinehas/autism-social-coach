<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Starry Night</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Starry Night Theme */
      .starry-night {
        background: linear-gradient(135deg, #0c0c23 0%, #1a1a3e 40%, #2d1b69 100%);
        position: relative;
        overflow: hidden;
        min-height: 100vh;
      }
      
      .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }
      
      .star {
        position: absolute;
        width: 2px;
        height: 2px;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
      }
      
      @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
      }
      
      .shooting-star {
        position: absolute;
        width: 100px;
        height: 2px;
        background: linear-gradient(90deg, transparent, white, transparent);
        animation: shoot 2s ease-out;
      }
      
      @keyframes shoot {
        from {
          transform: translateX(-100px) translateY(0);
          opacity: 1;
        }
        to {
          transform: translateX(300px) translateY(150px);
          opacity: 0;
        }
      }
      
      .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .content-area {
        position: relative;
        z-index: 10;
      }
      
      .activity-btn {
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .activity-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      }
      
      .moon {
        position: fixed;
        top: 60px;
        right: 80px;
        width: 80px;
        height: 80px;
        background: radial-gradient(circle, #ffeaa7 0%, #fdcb6e 100%);
        border-radius: 50%;
        box-shadow: 0 0 30px rgba(255, 234, 167, 0.5);
        z-index: 2;
      }
      
      .chat-area {
        max-height: 60vh;
        overflow-y: auto;
      }
    </style>
  </head>

  <body class="starry-night">
    <!-- Stars background -->
    <div class="stars" id="stars"></div>
    
    <!-- Moon -->
    <div class="moon"></div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 bg-black/50 backdrop-blur-lg flex items-center justify-center z-50">
      <div class="glass-card rounded-3xl p-8 max-w-md w-full text-white text-center">
        <h2 class="text-3xl font-bold mb-2">Welcome, Little Star!</h2>
        <p class="text-blue-200 mb-6">Let's get to know you a little better.</p>
        
        <div class="space-y-4 text-left">
          <div>
            <label for="name-input" class="font-bold mb-1 block">What is your name?</label>
            <input type="text" id="name-input" placeholder="E.g., Alex" class="w-full px-4 py-3 bg-white/20 backdrop-blur-md border border-white/30 rounded-full text-white placeholder-blue-200 focus:outline-none focus:border-white/50">
          </div>
          <div>
            <label for="age-input" class="font-bold mb-1 block">How old are you?</label>
            <input type="number" id="age-input" placeholder="E.g., 7" class="w-full px-4 py-3 bg-white/20 backdrop-blur-md border border-white/30 rounded-full text-white placeholder-blue-200 focus:outline-none focus:border-white/50">
          </div>
          <div>
            <label class="font-bold mb-2 block">What do you love?</label>
            <div id="interests-options" class="flex flex-wrap gap-2">
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this)">Trains üöÇ</button>
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this)">Dinosaurs ü¶ñ</button>
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this)">Space üöÄ</button>
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this)">Art üé®</button>
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this)">Music üéµ</button>
              <button class="interest-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" onclick="toggleInterest(this, true)">Other</button>
            </div>
            <input type="text" id="other-interest-input" placeholder="Type something you love..." class="hidden w-full mt-2 px-4 py-3 bg-white/20 backdrop-blur-md border border-white/30 rounded-full text-white placeholder-blue-200 focus:outline-none focus:border-white/50">
          </div>
        </div>

        <button 
          onclick="completeOnboarding()" 
          class="mt-8 bg-linear-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-8 py-3 rounded-full font-bold text-lg shadow-lg transform hover:scale-105 transition-all duration-300"
        >
          Let's Go! üöÄ
        </button>
      </div>
    </div>
    
    <!-- Main content -->
    <div class="content-area p-6">
      <div class="max-w-6xl mx-auto">
        
        <!-- Header -->
        <div class="glass-card rounded-3xl p-6 mb-6 text-center">
          <div class="flex items-center justify-between">
            <div class="flex items-center justify-center gap-4">
              <div class="text-6xl">‚ú®</div>
              <div>
                <h1 class="text-4xl font-bold text-white mb-2">Starry Night</h1>
                <p class="text-blue-200">Your magical learning companion</p>
              </div>
            </div>
            <div id="star-counter" class="flex items-center gap-2 text-yellow-300 text-2xl font-bold">
              <span>‚≠ê</span>
              <span id="star-count">0</span>
            </div>
          </div>
          
          <div id="child-name" class="text-2xl text-yellow-300 font-bold hidden mt-4"></div>
          
          <button 
            id="new-chat-btn" 
            class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full font-bold text-lg shadow-lg transform hover:scale-105 transition-all duration-300"
            onclick="startNewChat()"
          >
            üîÑ Start New Chat
          </button>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
          
          <!-- Activities Panel -->
          <div class="lg:col-span-1">
            <div class="glass-card rounded-3xl p-6">
              <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                üéØ Choose Your Adventure
              </h2>
              
              <div class="space-y-4">
                <div class="activity-btn bg-linear-to-br from-yellow-400 to-orange-500 rounded-2xl p-4 cursor-pointer" onclick="startActivity('morning')">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">‚òÄÔ∏è</span>
                    <div class="text-white">
                      <h3 class="font-bold">Morning Routine</h3>
                      <p class="text-sm opacity-90">Start your day right!</p>
                    </div>
                  </div>
                </div>
                
                <div class="activity-btn bg-linear-to-br from-blue-400 to-indigo-500 rounded-2xl p-4 cursor-pointer" onclick="startActivity('math')">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">üî¢</span>
                    <div class="text-white">
                      <h3 class="font-bold">Number Games</h3>
                      <p class="text-sm opacity-90">Fun with counting!</p>
                    </div>
                  </div>
                </div>
                
                <div class="activity-btn bg-linear-to-br from-purple-400 to-pink-500 rounded-2xl p-4 cursor-pointer" onclick="startActivity('feelings')">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">üí≠</span>
                    <div class="text-white">
                      <h3 class="font-bold">How I Feel</h3>
                      <p class="text-sm opacity-90">Share your emotions</p>
                    </div>
                  </div>
                </div>
                
                <div class="activity-btn bg-linear-to-br from-green-400 to-emerald-500 rounded-2xl p-4 cursor-pointer" onclick="startActivity('story')">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">ÔøΩ</span>
                    <div class="text-white">
                      <h3 class="font-bold">Story Time</h3>
                      <p class="text-sm opacity-90">Listen to magical tales!</p>
                    </div>
                  </div>
                </div>
                
                <div class="activity-btn bg-linear-to-br from-red-400 to-rose-500 rounded-2xl p-4 cursor-pointer" onclick="startActivity('praise')">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">‚≠ê</span>
                    <div class="text-white">
                      <h3 class="font-bold">Praise Time</h3>
                      <p class="text-sm opacity-90">Celebrate achievements!</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Progress -->
              <div class="mt-8 pt-6 border-t border-white/20">
                <h3 class="text-white font-bold mb-3">‚ú® Today's Adventures</h3>
                <div id="progress" class="text-blue-200 text-sm">
                  Ready to start your first adventure!
                </div>
              </div>
            </div>
          </div>
          
          <!-- Chat Area -->
          <div class="lg:col-span-2">
            <div class="glass-card rounded-3xl overflow-hidden h-full" style="min-height: 500px;">
              
              <!-- Current Activity Header -->
              <div id="activity-header" class="hidden bg-linear-to-r from-purple-600 to-pink-600 text-white p-4 text-center">
                <div class="flex items-center justify-center gap-2">
                  <span id="activity-emoji" class="text-2xl"></span>
                  <span id="activity-name" class="text-xl font-bold"></span>
                </div>
              </div>
              
              <!-- Messages Area -->
              <div id="messages" class="chat-area p-6 space-y-4 text-white" style="min-height: 400px;">
                <!-- Messages will appear here -->
              </div>
              
              <!-- Quick Action Buttons -->
              <div id="quick-actions" class="px-6 py-2">
                <!-- Dynamic buttons will appear here -->
              </div>
              
              <!-- Input Area -->
              <div class="bg-white/10 backdrop-blur-md p-4 border-t border-white/20">
                <div class="flex gap-3">
                  <input 
                    type="text" 
                    id="user-input" 
                    placeholder="Type your message..." 
                    class="flex-1 px-4 py-3 bg-white/20 backdrop-blur-md border border-white/30 rounded-full text-white placeholder-blue-200 focus:outline-none focus:border-white/50"
                    onkeypress="handleEnterKey(event)"
                  />
                  <button 
                    onclick="sendMessage()" 
                    class="bg-linear-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-6 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition-all duration-300"
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- State Management ---
      let state = {
        sessionId: `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
        childName: "",
        age: 0,
        interests: [],
        currentActivity: null,
        completedAdventures: [],
        assistantHistory: [],
        isMuted: false,
        starCount: 0,
      };

      // --- DOM Elements ---
      const dom = {
        childName: document.getElementById("child-name"),
        messages: document.getElementById("messages"),
        input: document.getElementById("user-input"),
        progress: document.getElementById("progress"),
        activityHeader: document.getElementById("activity-header"),
        activityEmoji: document.getElementById("activity-emoji"),
        activityName: document.getElementById("activity-name"),
        quickActions: document.getElementById("quick-actions"),
        stars: document.getElementById("stars"),
        starCount: document.getElementById("star-count"),
        onboardingModal: document.getElementById("onboarding-modal"),
        nameInput: document.getElementById("name-input"),
        ageInput: document.getElementById("age-input"),
        interestsInput: document.getElementById("interests-input"),
        otherInterestInput: document.getElementById("other-interest-input"),
      };

      // --- Constants ---
      const API_BASE = window.location.origin;
      const ACTIVITY_INFO = {
        morning: { emoji: "‚òÄÔ∏è", name: "Morning Routine" },
        math: { emoji: "üî¢", name: "Number Games" },
        feelings: { emoji: "üí≠", name: "How I Feel" },
        story: { emoji: "üìñ", name: "Story Time" },
        praise: { emoji: "‚≠ê", name: "Praise Time" },
      };

      // --- Core Functions ---
      window.onload = () => {
        loadState();
        createStars(150);
        setInterval(createShootingStar, 4000);
        if (!state.childName) {
          dom.onboardingModal.classList.remove('hidden');
        } else {
          dom.onboardingModal.classList.add('hidden');
          initializeSession();
        }
      };
      
      function toggleInterest(btn, isOther = false) {
        if (isOther) {
          dom.otherInterestInput.classList.toggle('hidden');
        } else {
          btn.classList.toggle('bg-purple-500');
          btn.classList.toggle('bg-white/20');
        }
      }

      function completeOnboarding() {
        const name = dom.nameInput.value.trim();
        const age = parseInt(dom.ageInput.value, 10);
        
        const selectedInterests = [];
        document.querySelectorAll('.interest-btn.bg-purple-500').forEach(btn => {
          selectedInterests.push(btn.textContent.trim());
        });
        const otherInterest = dom.otherInterestInput.value.trim();
        if (otherInterest) {
          selectedInterests.push(otherInterest);
        }

        if (!name || !age) {
          alert("Please tell us your name and age!");
          return;
        }

        state.childName = name;
        state.age = age;
        state.interests = selectedInterests;
        
        dom.onboardingModal.classList.add('hidden');
        initializeSession();
        saveState();
      }
      
      function initializeSession() {
        dom.childName.textContent = `Welcome, ${state.childName}! ‚ú®`;
        dom.childName.classList.remove("hidden");
        dom.starCount.textContent = state.starCount;
        updateProgress();
        addMessage("assistant", `Hello ${state.childName}! It's great to see you. What adventure should we go on today?`);
      }

      function startNewChat() {
        // Reset for a new chat, but keep user profile
        const persistentState = {
          childName: state.childName,
          age: state.age,
          interests: state.interests,
          starCount: state.starCount,
        };
        
        // Clear current session state
        state = {
          ...state, // keep all properties
          sessionId: `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
          currentActivity: null,
          completedAdventures: [],
          assistantHistory: [],
        };
        
        // Clear UI
        dom.messages.innerHTML = '';
        dom.activityHeader.classList.add('hidden');
        dom.quickActions.innerHTML = '';
        
        addMessage("assistant", `Let's start a new adventure, ${state.childName}! What would you like to do?`);
        saveState(); // Save the cleared state for the new session
      }

      function handleEnterKey(event) {
        if (event.key === "Enter") sendMessage();
      }

      async function sendMessage() {
        const message = dom.input.value.trim();
        if (!message) return;

        addMessage("user", message);
        dom.input.value = "";
        dom.quickActions.innerHTML = ''; // Clear quick actions on send

        const loadingId = addLoadingIndicator();

        try {
          const response = await fetch(`${API_BASE}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              sessionId: state.sessionId,
              state: {
                childName: state.childName,
                age: state.age,
                preferences: { interests: state.interests },
                currentActivity: state.currentActivity,
              }
            }),
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const data = await response.json();
          
          removeLoadingIndicator(loadingId);
          handleAssistantResponse(data.response);

        } catch (error) {
          console.error("Chat API error:", error);
          removeLoadingIndicator(loadingId);
          handleAssistantResponse("Oops! My stars are twinkling too fast. Can you say that again?");
        }
      }
      
      function handleAssistantResponse(text) {
        if (!text) return;

        // This logic was too simplistic and caused the "Tell me more!" loops.
        // The new backend prompt is designed to handle this better.
        // const lastMessage = state.assistantHistory[state.assistantHistory.length - 1];
        // if (lastMessage === text) {
        //   const variedResponses = ["That's so interesting!", "Tell me more!", "Wow!"];
        //   text = variedResponses[Math.floor(Math.random() * variedResponses.length)];
        // }
        
        state.assistantHistory.push(text);
        if(state.assistantHistory.length > 5) state.assistantHistory.shift();

        addMessage("assistant", text);
        saveState();
      }

      // --- State Persistence ---
      function saveState() {
        try {
          localStorage.setItem('starryNightState', JSON.stringify(state));
        } catch (e) {
          console.error("Could not save state to localStorage.", e);
        }
      }

      function loadState() {
        try {
          const savedState = localStorage.getItem('starryNightState');
          if (savedState) {
            const loaded = JSON.parse(savedState);
            // Create a new session ID each time, but keep profile
            state = {
              ...loaded,
              sessionId: `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
              currentActivity: null, // Reset activity on load
              completedAdventures: loaded.completedAdventures || [],
              assistantHistory: [], // Reset history on load
            };
          }
        } catch (e) {
          console.error("Could not load state from localStorage.", e);
        }
      }

      // --- UI Functions ---
      function addMessage(role, content) {
        const messageDiv = document.createElement("div");
        const isUser = role === "user";
        
        messageDiv.className = `flex ${isUser ? "justify-end" : "justify-start"}`;
        
        const bubbleColor = isUser
          ? "bg-gradient-to-r from-purple-600 to-pink-600"
          : "bg-white/20";
          
        messageDiv.innerHTML = `
          <div class="max-w-md ${bubbleColor} px-5 py-3 rounded-2xl shadow-lg">
            <p class="text-white text-lg">${content}</p>
          </div>
        `;
        
        dom.messages.appendChild(messageDiv);
        dom.messages.scrollTop = dom.messages.scrollHeight;

        if (role === "assistant" && !state.isMuted) {
          speak(content);
        }
      }

      function addLoadingIndicator() {
        const loadingId = `loading-${Date.now()}`;
        const loadingDiv = document.createElement("div");
        loadingDiv.id = loadingId;
        loadingDiv.className = "flex justify-start";
        loadingDiv.innerHTML = `
          <div class="bg-white/20 px-5 py-3 rounded-2xl shadow-lg flex items-center gap-2">
            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
          </div>
        `;
        dom.messages.appendChild(loadingDiv);
        dom.messages.scrollTop = dom.messages.scrollHeight;
        return loadingId;
      }

      function removeLoadingIndicator(id) {
        const indicator = document.getElementById(id);
        if (indicator) indicator.remove();
      }

      function startActivity(type) {
        state.currentActivity = type;
        const info = ACTIVITY_INFO[type];
        
        dom.activityEmoji.textContent = info.emoji;
        dom.activityName.textContent = info.name;
        dom.activityHeader.classList.remove("hidden");

        const activityHandler = clientActivityHandlers[type];
        if (activityHandler) {
          activityHandler();
        } else {
          addMessage("assistant", `Let's begin ${info.name}! What should we do first?`);
        }
        saveState();
      }

      function updateProgress() {
        if (state.completedAdventures.length === 0) {
          dom.progress.textContent = "Ready to start your first adventure!";
        } else {
          dom.progress.innerHTML = state.completedAdventures
            .map(type => {
              const info = ACTIVITY_INFO[type];
              return `<div class="flex items-center gap-2"><span class="text-lg">${info.emoji}</span>${info.name}</div>`;
            })
            .join("");
        }
      }

      function addStar() {
        state.starCount++;
        dom.starCount.textContent = state.starCount;
        
        // Fun animation when a star is earned
        const starCounter = document.getElementById('star-counter');
        starCounter.classList.add('transform', 'scale-150', 'transition-transform', 'duration-300');
        setTimeout(() => {
          starCounter.classList.remove('transform', 'scale-150');
        }, 300);
        saveState();
      }

      // --- Activity Handlers ---
      const clientActivityHandlers = {
        morning: () => {
          addMessage("assistant", "Let's get ready for a great day! What have you done so far?");
          const tasks = ["Brushed Teeth", "Got Dressed", "Ate Breakfast"];
          renderQuickActions(tasks, (task) => {
            addMessage("user", `I finished: ${task}`);
            handleAssistantResponse(`Great job on ${task}! You earned a star! ‚≠ê`);
            addStar();
            if (!state.completedAdventures.includes('morning')) {
              state.completedAdventures.push('morning');
              updateProgress();
            }
          });
        },
        math: () => {
          const num1 = Math.floor(Math.random() * 5) + 1;
          const num2 = Math.floor(Math.random() * 5) + 1;
          const answer = num1 + num2;
          addMessage("assistant", `Let's play a number game! What is ${num1} + ${num2}?`);
          
          const choices = [answer, answer + 1, answer - 1].sort(() => Math.random() - 0.5);
          renderQuickActions(choices, (choice) => {
            addMessage("user", choice);
            if (choice === answer) {
              handleAssistantResponse("That's correct! You're a math wizard! You get a star! üßô‚Äç‚ôÇÔ∏è");
              addStar();
              if (!state.completedAdventures.includes('math')) {
                state.completedAdventures.push('math');
                updateProgress();
              }
              setTimeout(() => clientActivityHandlers.math(), 2000); // Ask another question
            } else {
              handleAssistantResponse(`Good try! The answer was ${answer}. Let's try another one!`);
              setTimeout(() => clientActivityHandlers.math(), 2000);
            }
          });
        },
        feelings: () => {
          addMessage("assistant", "It's great to talk about our feelings. How are you feeling right now?");
          const feelings = ["Happy üòÑ", "Sad üò¢", "Excited üéâ", "Calm üòå", "Angry üò†", "Scared üò®"];
          renderQuickActions(feelings, (feeling) => {
            addMessage("user", `I'm feeling ${feeling.split(' ')[0]}`);
            // Let the backend handle the response now
            sendMessageFromActivity(`I am feeling ${feeling.split(' ')[0]}`);
            if (!state.completedAdventures.includes('feelings')) {
              state.completedAdventures.push('feelings');
              updateProgress();
            }
          });
        },
        story: () => {
          const stories = [
            "Once upon a time, in a land of twinkling stars, a friendly fox named Sparkle went on an adventure to find the moon's hidden treasure.",
            "A little rabbit who loved to count stars discovered a secret constellation that could grant one wish. What do you think he wished for?",
            "In a magical forest, every tree could sing a song. The tallest oak tree had the deepest voice and sang lullabies to all the sleepy animals."
          ];
          const story = stories[Math.floor(Math.random() * stories.length)];
          addMessage("assistant", "Let's imagine a story! " + story);
          renderQuickActions(["What happens next?", "Tell me another!"], (action) => {
            addMessage("user", action);
            if (action === "Tell me another!") {
              setTimeout(() => clientActivityHandlers.story(), 1000);
            } else {
              handleAssistantResponse("That's a great question! You earned a star for being creative! What do YOU think happens next?");
              addStar();
            }
             if (!state.completedAdventures.includes('story')) {
                state.completedAdventures.push('story');
                updateProgress();
              }
          });
        },
        praise: () => {
          addMessage("assistant", "Tell me something amazing you did today. I want to celebrate with you!");
          renderQuickActions(["I was kind to a friend", "I finished my homework", "I helped my parents"], (praise) => {
            addMessage("user", praise);
            handleAssistantResponse(`That is wonderful! You should be so proud of yourself! You get a star for that! üåü`);
            addStar();
            if (!state.completedAdventures.includes('praise')) {
              state.completedAdventures.push('praise');
              updateProgress();
            }
          });
        },
      };

      async function sendMessageFromActivity(message) {
        const loadingId = addLoadingIndicator();
        try {
          const response = await fetch(`${API_BASE}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message,
              sessionId: state.sessionId,
              state: {
                childName: state.childName,
                age: state.age,
                preferences: { interests: state.interests },
                currentActivity: state.currentActivity,
              }
            }),
          });
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          removeLoadingIndicator(loadingId);
          handleAssistantResponse(data.response);
        } catch (error) {
          console.error("Chat API error:", error);
          removeLoadingIndicator(loadingId);
          handleAssistantResponse("Oops! My stars are twinkling too fast. Can you say that again?");
        }
      }

      // --- Background Effects ---
      function createStars(count) {
        for (let i = 0; i < count; i++) {
          const star = document.createElement("div");
          star.className = "star";
          star.style.top = `${Math.random() * 100}%`;
          star.style.left = `${Math.random() * 100}%`;
          star.style.animationDelay = `${Math.random() * 3}s`;
          dom.stars.appendChild(star);
        }
      }

      function createShootingStar() {
        const star = document.createElement("div");
        star.className = "shooting-star";
        star.style.top = `${Math.random() * 60}%`;
        star.style.left = `-${Math.random() * 100}px`;
        star.style.animationDuration = `${Math.random() * 2 + 1.5}s`;
        dom.stars.appendChild(star);
        setTimeout(() => star.remove(), 3000);
      }

      // --- Text-to-Speech ---
      function speak(text) {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          utterance.pitch = 1.1;
          speechSynthesis.speak(utterance);
        }
      }
      
      function renderQuickActions(actions, callback) {
        dom.quickActions.innerHTML = '';
        actions.forEach(action => {
          const button = document.createElement('button');
          button.className = 'bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full text-sm transition-all';
          button.textContent = action;
          button.onclick = () => {
            callback(action);
            dom.quickActions.innerHTML = ''; // Clear after click
          };
          dom.quickActions.appendChild(button);
        });
      }
    </script>
  </body>
</html>
